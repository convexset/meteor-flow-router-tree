# FlowRouterTree

A tool for facilitating the creation of a clean set of [FlowRouter](https://github.com/kadirahq/flow-router) routes. The idea is that routes might be viewed as a forest of trees, and child nodes (routes) should inherit configuration aspects of parent nodes (routes) by default unless the settings are explicitly changed. This cleans up one's `routes.js` substantially.

## Table of Contents

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Install](#install)
- [Usage By Example](#usage-by-example)
    - [Options](#options)
    - [Additional Properties and Methods (Post Creation)](#additional-properties-and-methods-post-creation)
    - [Possibly Useful Helpers](#possibly-useful-helpers)
    - [Debug](#debug)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Install

This is available as [`convexset:flow-router-tree`](https://atmospherejs.com/convexset/flow-router-tree) on [Atmosphere](https://atmospherejs.com/). (Install with `meteor add convexset:flow-router-tree`.)

If you get an error message like:
```
WARNING: npm peer requirements not installed:
 - package-utils@^0.2.1 not installed.
          
Read more about installing npm peer dependencies:
  http://guide.meteor.com/using-packages.html#peer-npm-dependencies
```
It is because, by design, the package does not include instances of these from `npm` to avoid repetition. (In this case, `meteor npm install --save package-utils` will deal with the problem.)

See [this](http://guide.meteor.com/using-packages.html#peer-npm-dependencies) or [this](https://atmospherejs.com/tmeasday/check-npm-versions) for more information.

Now, if you see a message like
```
WARNING: npm peer requirements not installed:
underscore@1.5.2 installed, underscore@^1.8.3 needed
```
it is because you or something you are using is using Meteor's cruddy old `underscore` package. Install a new version from `npm`. (And, of course, you may use the `npm` version in a given scope via `require("underscore")`.)


## Usage By Example

See the example in `./demo/`.

Start by creating a root node. Here is one with all the options in. (Scary perhaps, but it's nice.)

```javascript
var root = FlowRouterTree.createNode({
    name: 'rootNode',
    description: "Main",
    path: '',
    params: {
        layout: "MainLayout",
        header: "Header",
        content: "Main",
        footer: "Footer"
    },
    actionFactory: FlowRouterTree.configureParameterizedAction(
        function blazeLayoutRenderThreeComponent(params, queryParams, actionParams) {
            BlazeLayout.render(actionParams.layout, {
                header: actionParams.header,
                content: actionParams.content,
                footer: actionParams.footer,
                routeParams: {
                    params: params,
                    queryParams: queryParams
                }
            });
        },
        ['layout', 'header', 'content', 'footer']
    ),
    triggersEnter: {
        enterTrigger: function(context, redirect) {
            console.log('Entry Trigger');
            console.log('Context:', context);
        }
    },
    triggersExit: {
        exitTrigger: function(context, redirect) {
            console.log('Default Exit Trigger');
        }
    },
    providesParentRoutePrefix: true,
    makeRoute: true,
});
```

Here are the default options:

```javascript
{
    parent: null,
    params: {},
    actionFactory: null,
    triggersEnter: {},
    triggersExit: {},
    providesParentRoutePrefix: false,
    makeRoute: true,
    description: ""
}
```

#### Options

Option                      | Description
:-------------------------: | --------------
`parent`                    | parent node
`path`                      | Path component. The full route is generated by combining path components, such as `/component_1/component_2/.../component_n`. But with caveats, see `providesParentRoutePrefix`.
`providesParentRoutePrefix` | Indicates whether this path component is included in those of this node's children. It is always included in the route for this node. e.g.: if `component_2` is left out, we obtain `/component_1/component_3/.../component_n`.
`actionFactory`             | A parameterized version of FlowRouter [actions](https://github.com/kadirahq/flow-router#routes-definition). This means passing a parameterized action function (with an additional third argument containing an objects with parameters) through `FlowRouterTree.configureParameterizedAction` like so: `FlowRouterTree.configureParameterizedAction(actionParameterized, ['nameOfParam1', 'nameOfParam2', ...])`
`params`                    | Parameters that will be passed into the parameter factory. The parameters passed are those specified in the call to `FlowRouterTree.configureParameterizedAction` (in the array of argument names). If not present, they will be inherited from the nearest ancestor node where it is specified.
`triggersEnter`             | A dictionary (object) of `FlowRouter` entry [triggers](https://github.com/kadirahq/flow-router#triggers). Inherits from parents by key (name). Override using `null`.
`triggersExit`              | A dictionary (object) of `FlowRouter` entry [triggers](https://github.com/kadirahq/flow-router#triggers). Inherits from parents by key (name). Override using `null`.
`makeRoute`                 | Whether node provides an actual route (if false, it is just a placeholder)
`description`               | A text description of the node
`accessChecks`               | See [convexset:access-check](https://atmospherejs.com/convexset/access-check#meteor-methods-and-publications) and use the same format as the `accessChecks` key. (Leaving unset implies inheritance from parent; Defining `accessChecks` overwrites checks on the parent, if applicable; Set to `null` to not inherit checks from parent)

#### The `accessChecks` key: Using [convexset:access-check](https://atmospherejs.com/convexset/access-check)

Use the same syntax as access checks for Meteor Methods and Publications in [convexset:access-check](https://atmospherejs.com/convexset/access-check#meteor-methods-and-publications) apply (via the `accessChecks` key).

The `where` sub-key is ignored, however and set to refer to the client.

Generally speaking, client-side failure callbacks should result in routing to a page which the current user is more likely to be authorized to be on. For example, access controls on a restricted route/template might boot an unauthorized user to the "main user dashboard" (MUD?) and access controls on the MUD might boot an unauthorized user to the login page (where probably no access controls apply except perhaps geographical ones by IP address, in which case...)

Access checks are implemented as ["entry triggers"](https://github.com/kadirahq/flow-router/#triggers) and will be the first in the list.

Checks and failure callbacks are invoked with the following context (i.e.: "`this`"):
```
{
    context: context,
    redirect: redirect,
    stop: stop
}
```
as provided in [FlowRouter triggers](https://github.com/kadirahq/flow-router/#triggers) (see this for use of [`stop`](https://github.com/kadirahq/flow-router/#stopping-the-callback-with-triggers)).


#### Additional Properties and Methods (Post Creation)

Property / Method           | Description
:-------------------------: | --------------
`route`                     | the route of this node
`routePrefix`               | the route prefix of this node
`roots()`                   | returns the names of root nodes (nodes with no parents)
`nodes`                     | a dictionary (object) of node names pointing to nodes
`tree`                      | a dictionary of nodes names each pointing to the name of the relevant parent node

#### Possibly Useful Helpers

The `FlowRouterTree.SampleParameterizedActions` dictionary:
 - `blazeLayoutRenderThreeComponent` with parameters `['layout', 'header', 'content', 'footer']` (actual source featured above)
 - `blazeLayoutRenderOneComponent` with parameters `['layout', 'content']`

The `FlowRouterTree.SampleTriggerFactories` dictionary:
 - `redirectAfterLoginFactory(loginRouteName, sessionVariableNameForRedirectPath)`: Provides route-level authentication, redirecting visitors to the login screen if not authenticated and sends the user back once logged-in. See [this](https://medium.com/@satyavh/using-flow-router-for-authentication-ba7bb2644f42) for more information.


#### Debug
 - `FlowRouterTree.showDebugOutputOnServer()`: show debug output on the server
 - `FlowRouterTree.hideDebugOutput()`: stop showing debug output on the server

